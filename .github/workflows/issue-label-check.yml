name: Issue Label Enforcement

on:
  issues:
    types: [opened, edited, labeled, unlabeled]

jobs:
  enforce-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Check labels
        id: label_check
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);

            const hasWhat = labels.some(l =>
              l.startsWith('design-') ||
              l.startsWith('verification-') ||
              l === 'docs'
            );

            const hasWhy = ['feature','bug','enhancement','cleanup']
              .some(l => labels.includes(l));

            const hasWhen = labels.some(l => l.startsWith('P'));

            if (!hasWhat || !hasWhy || !hasWhen) {
              core.setFailed('Missing WHAT, WHY, or WHEN label');
            }

      - name: Notify Discord on failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          ISSUE_URL="${{ github.event.issue.html_url }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"ðŸš¨ **Issue Label Validation Failed**\n\n**Title:** ${ISSUE_TITLE}\n**Author:** ${ISSUE_AUTHOR}\n**Issue:** ${ISSUE_URL}\n\nâž¡ Please add WHAT, WHY, and WHEN labels.\"
               }" \
               $DISCORD_WEBHOOK
