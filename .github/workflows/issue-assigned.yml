name: Issue Assigned Automation

on:
  issues:
    types: [assigned]

jobs:
  issue_assigned:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # Step 1: Decide Discord role based on labels
      # -----------------------------------------
      - name: Decide role mention
        id: role
        run: |
          ROLE="@everyone"

          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"

          if [[ "$LABELS" == *"verification"* ]]; then
            ROLE="<@&${{ vars.DISCORD_VERIFICATION_ROLE_ID }}>"
          elif [[ "$LABELS" == *"design"* ]]; then
            ROLE="<@&${{ vars.DISCORD_DESIGN_ROLE_ID }}>"
          fi

          echo "role=$ROLE" >> $GITHUB_OUTPUT

      # -----------------------------------------
      # Decide Discord Webhook based on labels
      # -----------------------------------------

      - name: Decide Discord webhook
        id: webhook
        run: |
            WEBHOOK="${{ secrets.DISCORD_WEBHOOK }}"

            LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"

            if [[ "$LABELS" == *"verification"* ]]; then
            WEBHOOK="${{ secrets.DISCORD_VERIFICATION_WEBHOOK }}"
            elif [[ "$LABELS" == *"design"* ]]; then
            WEBHOOK="${{ secrets.DISCORD_DESIGN_WEBHOOK }}"
            fi

            echo "webhook=$WEBHOOK" >> $GITHUB_OUTPUT

      # -----------------------------------------
      # Step 2: Send Discord notification
      # -----------------------------------------
      - name: Notify Discord
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ steps.webhook.outputs.webhook }}
        with:
          args: |
            ğŸ”¹ **Issue Assigned**
            
            ğŸ“Œ **Issue #${{ github.event.issue.number }}**  
            ğŸ“ **${{ github.event.issue.title }}**  
            ğŸ‘¤ **Assigned to:** @${{ github.event.assignee.login }}  
            ğŸ“‚ **Repo:** ${{ github.repository }}

            ${{ steps.role.outputs.role }}

            âœ… You are now responsible for this task.

      # -----------------------------------------
      # Step 3: Add checklist to the issue
      # -----------------------------------------
      - name: Add checklist to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "**ğŸ§© Assignment Checklist**
            
            - [ ] Understand issue requirements  
            - [ ] Update testcase / RTL / TB  
            - [ ] Run simulation & debug  
            - [ ] Push changes  
            - [ ] Raise PR & link this issue"
