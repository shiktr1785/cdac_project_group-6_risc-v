name: Discord Issue Router (Enhanced)

on:
  issues:
    types: [opened, assigned, closed]

jobs:
  route:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # Step 1: Prepare routing and rich context
      # -----------------------------------------
      - name: Prepare routing and message
        id: ctx
        run: |
          ACTION="${{ github.event.action }}"
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"

          WEBHOOK="${{ secrets.DISCORD_WEBHOOK }}"
          ROLE=""
          TITLE=""
          COLOR=""
          EXTRA=""

          # Route by label
          if [[ "$LABELS" == *"verification"* ]]; then
            WEBHOOK="${{ secrets.DISCORD_VERIFICATION_WEBHOOK }}"
            ROLE="<@&${{ vars.DISCORD_VERIFICATION_ROLE_ID }}>"
            COLOR="üß™"
          elif [[ "$LABELS" == *"design"* ]]; then
            WEBHOOK="${{ secrets.DISCORD_DESIGN_WEBHOOK }}"
            ROLE="<@&${{ vars.DISCORD_DESIGN_ROLE_ID }}>"
            COLOR="üß†"
          fi

          # Event-aware message
          case "$ACTION" in
            opened)
              TITLE="üÜï New Issue Created"
              ;;
            assigned)
              TITLE="üë§ Issue Assigned"
              EXTRA="üë§ Assigned to: @${{ github.event.assignee.login }}"
              ;;
            closed)
              TITLE="‚úÖ Issue Closed"
              ;;
          esac

          echo "webhook=$WEBHOOK" >> $GITHUB_OUTPUT
          echo "role=$ROLE" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "extra=$EXTRA" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT

      # -----------------------------------------
      # Step 2: Notify Discord (rich but quiet)
      # -----------------------------------------
      - name: Notify Discord
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ steps.ctx.outputs.webhook }}
        with:
          args: |
            **${{ steps.ctx.outputs.color }} ${{ steps.ctx.outputs.title }}**

            üìå **Issue #${{ github.event.issue.number }}**
            üìù **${{ github.event.issue.title }}**

            üóÇ **Repo:** ${{ github.repository }}
            ${{ steps.ctx.outputs.extra }}

            üîó ${{ github.event.issue.html_url }}

            ${{ steps.ctx.outputs.role }}

      # -----------------------------------------
      # Step 3: Add checklist on first assignment
      # -----------------------------------------
      - name: Add assignment checklist
        if: github.event.action == 'assigned'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          BODY=$(gh issue view ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --json body \
            -q .body)

          # Prevent duplicate checklist
          if echo "$BODY" | grep -q "üß© Assignment Checklist"; then
            echo "Checklist already present. Skipping."
            exit 0
          fi

          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "**üß© Assignment Checklist**
            
            - [ ] Understand issue requirements  
            - [ ] Update testcase / RTL / TB  
            - [ ] Run simulation & debug  
            - [ ] Push changes  
            - [ ] Raise PR & link this issue"
